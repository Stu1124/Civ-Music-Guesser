<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Civ Music Guesser – Music History Listening Lab</title>
    <meta name="description" content="Interactive music history listening lab. Guess the genre of each piece, then reveal composer, context, and key characteristics.">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/lucide/0.263.1/umd/lucide.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;600;700;800&display=swap');

        :root {
            --bg: #1f2937;
            --surface: #111827;
            --surface-soft: #0f172a;
            --text: #e5e7eb;
            --muted: #94a3b8;
            --line: #334155;
            --brand: #0f766e;
            --brand-dark: #115e59;
            --accent: #cbd5e1;
            --ok: #059669;
            --bad: #dc2626;
        }

        body {
            font-family: 'Manrope', sans-serif;
            color: var(--text);
            background: var(--bg);
        }

        .shell {
            width: 100%;
            max-width: none;
            margin: 0;
            padding: 0;
        }

        .card {
            background: var(--surface);
            border: 1px solid var(--line);
            border-radius: 0;
            box-shadow: 0 8px 24px rgba(2, 6, 23, 0.28);
        }

        .input-glow:focus {
            border-color: #14b8a6;
            box-shadow: 0 0 0 4px rgba(20, 184, 166, 0.14);
        }

        .btn-primary {
            background: var(--brand);
            color: #ffffff;
            border: 1px solid var(--brand);
            font-weight: 700;
        }

        .btn-primary:hover { background: var(--brand-dark); }

        .btn-soft {
            background: #1e293b;
            color: #e2e8f0;
            border: 1px solid #475569;
            font-weight: 600;
        }

        .btn-soft:hover { background: #334155; }

        .btn-notebook {
            background: #0b1220;
            color: #e2e8f0;
            border: 1px solid #64748b;
            font-weight: 700;
        }

        .btn-notebook:hover {
            background: #111827;
            border-color: #94a3b8;
        }

        .thin-progress {
            background: #334155;
            border-radius: 9999px;
            overflow: hidden;
            height: 0.6rem;
        }

        .thin-progress > span {
            display: block;
            width: 0%;
            height: 100%;
            background: linear-gradient(90deg, #14b8a6, #0f766e);
            transition: width 260ms ease;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .reveal-anim { animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1) forwards; }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #3a4f6f; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #4f6990; }
    </style>
</head>
<body class="min-h-screen">
    <main class="shell min-h-screen">
        <div class="card overflow-hidden min-h-screen">
        <section class="p-3 sm:p-4 border-b border-slate-700/80">
            <div class="flex flex-col gap-2 sm:flex-row sm:items-center sm:justify-between mb-3">
                <h2 class="text-lg sm:text-xl font-extrabold text-slate-100">Civ Music Guesser</h2>
                <div class="flex items-center gap-2 self-start sm:self-auto">
                    <a href="https://notebooklm.google.com/notebook/ff074ee3-5859-432e-ab5c-a068cbb613bd" target="_blank" rel="noopener noreferrer" class="btn-notebook px-3 py-1.5 rounded-lg text-xs sm:text-sm inline-flex items-center gap-1.5">
                        <svg aria-hidden="true" viewBox="0 0 24 24" class="w-3.5 h-3.5 text-cyan-300" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                            <rect x="4" y="3" width="16" height="18" rx="2"></rect>
                            <path d="M8 3v18"></path>
                            <path d="M11 7h6"></path>
                            <path d="M11 11h6"></path>
                            <path d="M11 15h4"></path>
                        </svg>
                        NotebookLM
                    </a>
                </div>
            </div>

            <div id="media-container" class="w-full min-h-[230px] sm:min-h-[290px] rounded-xl border border-slate-700 overflow-hidden bg-slate-900 flex items-center justify-center">
                <div class="text-slate-500 flex flex-col items-center animate-pulse">
                    <i data-lucide="loader" class="w-10 h-10 mb-3 animate-spin text-teal-700"></i>
                    <p class="text-sm font-medium tracking-wide">LOADING AUDIO...</p>
                </div>
            </div>
        </section>

        <section class="p-4 sm:p-5 flex flex-col gap-4 border-b border-slate-700/80">
            <div class="flex flex-col sm:flex-row sm:items-start sm:justify-between gap-3">
                <div>
                    <p class="text-[11px] uppercase tracking-[0.14em] text-teal-400 font-bold">Identify The Genre</p>
                    <h2 class="text-2xl sm:text-3xl font-extrabold text-slate-100 mt-1">What genre is this piece?</h2>
                    <p class="text-sm text-slate-500 mt-2">
                        Submit your guess below.
                    </p>
                </div>
                <div class="flex flex-wrap items-center justify-start sm:justify-end gap-2">
                    <div class="text-xs font-semibold text-slate-300 bg-slate-800/90 px-3 py-2 rounded-full border border-slate-600/80">
                        TRACK <span id="current-count" class="text-white font-extrabold">1</span> / <span id="total-count">0</span>
                    </div>
                    <div id="mode-badge" class="text-xs font-semibold text-cyan-200 bg-cyan-900/25 px-3 py-2 rounded-full border border-cyan-700/50">
                        MODE: Full Quiz
                    </div>
                    <button onclick="prevQuestion()" class="btn-soft w-10 h-10 rounded-xl inline-flex items-center justify-center text-lg font-bold" title="Previous Piece" aria-label="Previous Piece">
                        <span aria-hidden="true">&larr;</span>
                    </button>
                    <button onclick="nextQuestion()" class="btn-soft w-10 h-10 rounded-xl inline-flex items-center justify-center text-lg font-bold" title="Next Piece" aria-label="Next Piece">
                        <span aria-hidden="true">&rarr;</span>
                    </button>
                </div>
            </div>

            <div class="space-y-2 pt-1">
                <div class="flex items-center justify-between text-xs text-slate-300">
                    <div class="flex items-center gap-2">
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full border border-emerald-700/50 bg-emerald-900/25 text-emerald-200">
                            <span class="text-emerald-300/90 font-semibold">C</span>
                            <span id="correct-count" class="font-bold text-emerald-300">0</span>
                        </span>
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full border border-rose-700/50 bg-rose-900/25 text-rose-200">
                            <span class="text-rose-300/90 font-semibold">I</span>
                            <span id="incorrect-count" class="font-bold text-rose-300">0</span>
                        </span>
                        <span class="inline-flex items-center gap-1.5 px-2.5 py-1 rounded-full border border-sky-700/50 bg-sky-900/25 text-sky-200">
                            <span class="text-sky-300/90 font-semibold">Accuracy</span>
                            <span id="accuracy" class="font-bold text-sky-300">0%</span>
                        </span>
                    </div>
                    <span class="text-slate-500 font-medium">Progress</span>
                </div>
                <div class="thin-progress">
                    <span id="progress-fill"></span>
                </div>
            </div>

            <div id="input-area" class="flex flex-col sm:flex-row gap-3">
                <input type="text" id="user-guess"
                    class="flex-grow bg-slate-900 border border-slate-600 rounded-xl px-4 py-3 text-lg text-slate-100 placeholder-slate-500 outline-none input-glow transition-all"
                    placeholder="Type your genre guess..."
                    autocomplete="off"
                    onkeypress="handleKeyPress(event)">
                <button id="submit-btn" onclick="checkAnswer()" class="btn-primary px-7 py-3 rounded-xl text-base">
                    Check
                </button>
            </div>
        </section>

        <section id="feedback-panel" class="p-4 sm:p-4 hidden flex-col gap-3 reveal-anim">
            <div id="result-banner" class="p-4 rounded-xl flex items-center gap-3 border"></div>
            <div class="bg-slate-900 rounded-xl border border-slate-700 p-4">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-2 sm:gap-3">
                    <div class="rounded-lg bg-slate-950/60 border border-slate-700 px-3 py-2">
                        <p class="text-[10px] uppercase tracking-wider text-slate-400">Genre</p>
                        <p id="info-title" class="text-slate-100 text-lg font-extrabold leading-tight"></p>
                    </div>
                    <div class="rounded-lg bg-slate-950/60 border border-slate-700 px-3 py-2">
                        <p class="text-[10px] uppercase tracking-wider text-slate-400">Title</p>
                        <p id="info-composer" class="text-slate-200 font-semibold"></p>
                    </div>
                    <div class="rounded-lg bg-slate-950/60 border border-slate-700 px-3 py-2">
                        <p class="text-[10px] uppercase tracking-wider text-slate-400">Artist</p>
                        <p id="info-context" class="text-slate-200"></p>
                    </div>
                </div>
                <div class="mt-3 pt-3 border-t border-slate-700/80">
                    <p class="text-[10px] uppercase tracking-wider text-slate-400 mb-1">Key Characteristics</p>
                    <p id="info-characteristics" class="text-slate-200 leading-relaxed"></p>
                </div>
            </div>
        </section>
        </div>
    </main>

    <div id="toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-slate-900 text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-all transform translate-y-10 pointer-events-none z-50 flex items-center gap-3">
        <i data-lucide="info" class="text-teal-300 w-5 h-5"></i>
        <span id="toast-msg">Notification</span>
    </div>

    <div id="end-quiz-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/75 p-4">
        <div class="w-full max-w-md rounded-2xl border border-slate-700 bg-slate-900 p-6 shadow-2xl">
            <p class="text-[11px] uppercase tracking-[0.14em] text-teal-400 font-bold">Playlist Complete</p>
            <h3 class="mt-2 text-2xl font-extrabold text-slate-100">What would you like to do next?</h3>
            <p class="mt-2 text-sm text-slate-400">You can review your results or restart with a fresh score.</p>
            <div class="mt-5 flex flex-col sm:flex-row gap-3">
                <button onclick="showResultsSummary()" class="btn-primary rounded-xl px-4 py-2.5 text-sm">View Results</button>
                <button onclick="startMissedRound()" class="btn-soft rounded-xl px-4 py-2.5 text-sm">Practice Missed</button>
                <button onclick="restartQuiz()" class="btn-soft rounded-xl px-4 py-2.5 text-sm">Restart</button>
            </div>
        </div>
    </div>

    <div id="results-modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-slate-950/75 p-4">
        <div class="w-full max-w-2xl rounded-2xl border border-slate-700 bg-slate-900 p-6 shadow-2xl max-h-[85vh] overflow-y-auto">
            <p class="text-[11px] uppercase tracking-[0.14em] text-teal-400 font-bold">Results</p>
            <h3 class="mt-2 text-2xl font-extrabold text-slate-100">How You Did</h3>
            <p id="results-summary" class="mt-2 text-sm text-slate-400"></p>
            <div class="mt-5 grid grid-cols-1 sm:grid-cols-2 gap-4">
                <div class="rounded-xl border border-emerald-700/50 bg-emerald-950/20 p-3">
                    <p class="text-sm font-bold text-emerald-300">Correct</p>
                    <ul id="correct-list" class="mt-2 text-sm text-emerald-100 space-y-1"></ul>
                </div>
                <div class="rounded-xl border border-rose-700/50 bg-rose-950/20 p-3">
                    <p class="text-sm font-bold text-rose-300">Incorrect</p>
                    <ul id="incorrect-list" class="mt-2 text-sm text-rose-100 space-y-1"></ul>
                </div>
            </div>
            <div class="mt-5 flex flex-col sm:flex-row gap-3">
                <button onclick="startMissedRound()" class="btn-soft rounded-xl px-4 py-2.5 text-sm">Practice Missed</button>
                <button onclick="restartQuiz()" class="btn-primary rounded-xl px-4 py-2.5 text-sm">Restart</button>
                <button onclick="closeResultsModal()" class="btn-soft rounded-xl px-4 py-2.5 text-sm">Close</button>
            </div>
        </div>
    </div>

    <script>
        // --- DATA ---
        // Manually mapped from your provided list.
        // NOTE: Google Drive 'view' links have been auto-converted to 'preview' in the code logic below.
        const fullQuizData = [
            { genre: "Symphony", title: "Symphony 3", composer: "Beethoven", characteristics: "Multi-movement for orchestra; typically 25 mins - 1 hour with 4 movements (fast, slow, minuet, fast) using different musical themes in the same keys.", context: "Not provided", link: "https://drive.google.com/file/d/1mxU0oWiN2i_LotAQuYzVVmzRwJl3HTwX/view?usp=drive_link" },
            { genre: "Symphony", title: "Symphony 5", composer: "Beethoven", characteristics: "Multi-movement for orchestra; typically 25 mins - 1 hour with 4 movements (fast, slow, minuet, fast) using different musical themes in the same keys.", context: "Not provided", link: "https://drive.google.com/file/d/1xvGRhOuSYvKW0HdsdiA9xAVf_D52Rnj9/view?usp=drive_link" },
            { genre: "Trumpet Concerto", title: "Trumpet Concerto in E flat", composer: "Haydn", characteristics: "Features a remodeled trumpet that gained valves; famously advanced by maker Anton Weidinger.", context: "Not provided", link: "https://drive.google.com/file/d/1Iy1JPVB1CVBQlLTkg9U2lczQtY4a7jCn/view?usp=drive_link" },
            { genre: "Serenade", title: "A Little Night Music", composer: "Mozart", characteristics: "Light and airy multi-movement piece for a 4-string ensemble or small orchestra, intended for outdoor evening entertainment.", context: "Not provided", link: "https://drive.google.com/file/d/1m3gA3TTEia-I0sYf82ez1oBmOU4bguhw/view?usp=drive_link" },
            { genre: "Theme and Variation (form)", title: "Twinkle twinkle", composer: "Mozart", characteristics: "A form where an individual composer demonstrates creativity by taking popular music and changing the melodic lines.", context: "Not provided", link: "https://drive.google.com/file/d/1UGUGyma998fL_wWQBVpeEUiIXaX9d3B7/view?usp=drive_link" },
            { genre: "String Quartet", title: "Emperor Quartet", composer: "Haydn", characteristics: "Chamber/salon music for small, intimate spaces; features four movements unified by key with one player per part and no conductor.", context: "Not provided", link: "https://drive.google.com/file/d/1kBTbqz2a4dpmXlcEvPCgqY5IxopOYdl3/view?usp=drive_link" },
            { genre: "Comic Opera (Buffa)", title: "Don Giovanni", composer: "Mozart", characteristics: "Opera focusing on middle class values, social change, and everyday characters and scenes.", context: "Not provided", link: "https://drive.google.com/file/d/1OfABJBzGanlp5XXLdAqZWsy7yKKpyvxW/view?usp=drive_link" },
            { genre: "Sonata", title: "Piano Sonata", composer: "Beethoven", characteristics: "Multi-movement work for a solo instrument with accompaniment, designed for intimate, small settings for amateurs.", context: "Not provided", link: "https://drive.google.com/file/d/1gVBFqgQPqBYxVKocLY3Bo8vA3qqoHojK/view?usp=drive_link" },
            { genre: "Art Song", title: "Elf King", composer: "Franz Schubert", characteristics: "Solo voice with piano accompaniment; a fusion of poetry and music featuring strophic form and word painting.", context: "Not provided", link: "https://drive.google.com/file/d/1OZOd8CcQmKYdLTKHyOQJB1Y2FpMaSbR6/view?usp=drive_link" },
            { genre: "Art Song", title: "If you love for beauty", composer: "Clara Schumann", characteristics: "Solo voice with piano accompaniment; a fusion of poetry and music featuring strophic form and word painting.", context: "Not provided", link: "https://drive.google.com/file/d/1aueZB2fVPz5ZmonyCAIBxV_qjcv0Rh1T/view?usp=drive_link" },
            { genre: "Nocturne", title: "Nocturne in E flat major", composer: "Frédéric Chopin", characteristics: "Slow, dreamy piano music meant to evoke moonlit nights; features strumming rhythms and a melody playing over a solid bass line.", context: "Not provided", link: "https://drive.google.com/file/d/12FQ9l3hFpF2P45xDLI1Y7Q1DyNqVPltB/view?usp=drive_link" },
            { genre: "Tone/Symphonic Poem", title: "Romeo and Juliet", composer: "Tchaikovsky", characteristics: "A 1-movement work for orchestra intended for the concert hall to portray emotions/events.", context: "Not provided", link: "https://drive.google.com/file/d/1okFX5BOkfU0TnYnygSGyIsKNVChJu-BL/view?usp=drive_link" },
            { genre: "Program Symphony", title: "Symphonie Fantastique", composer: "Hector Berlioz", characteristics: "A multi-movement work (3-5 movements) that tells a tale/story from an extra-musical source.", context: "Not provided", link: "https://drive.google.com/file/d/1yUxbS23aURAUgWvLiqqH6GS2v33tZdNf/view?usp=drive_link" },
            { genre: "Ballet Music", title: "Nutcracker (dance of reed pipes)", composer: "Tchaikovsky", characteristics: "Dramatic dance featuring short bursts of tuneful melodies and pulsating rhythms where characters tell a story through stylized steps and facial expressions.", context: "Not provided", link: "https://drive.google.com/file/d/14a8PwH1ha3mp2lGW1S-L8msVTZlbrYCM/view?usp=drive_link" }
        ];

        // --- STATE & UTILS ---
        let currentIndex = 0;
        let answered = false;
        let lastUserGuess = "";
        let correctCount = 0;
        let incorrectCount = 0;
        let questionResults = [];
        let activeQuizData = [];
        let roundMode = 'full';

        // Shuffle Array
        function shuffle(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // Initialize Icons
        function initIcons() {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function updateScoreboard() {
            const total = correctCount + incorrectCount;
            const accuracy = total === 0 ? 0 : Math.round((correctCount / total) * 100);

            document.getElementById('correct-count').innerText = correctCount;
            document.getElementById('incorrect-count').innerText = incorrectCount;
            document.getElementById('accuracy').innerText = `${accuracy}%`;
        }

        function updateProgress(index) {
            const total = activeQuizData.length || 1;
            const current = index + 1;
            const percent = Math.min(100, Math.round((current / total) * 100));
            const fill = document.getElementById('progress-fill');

            if (fill) fill.style.width = `${percent}%`;
        }

        function updateRoundBadge() {
            const badge = document.getElementById('mode-badge');
            if (!badge) return;
            badge.innerText = `MODE: ${roundMode === 'missed' ? 'Missed Practice' : 'Full Quiz'}`;
        }

        function normalizeText(value) {
            return value
                .toLowerCase()
                .normalize('NFD')
                .replace(/[\u0300-\u036f]/g, '')
                .replace(/&/g, ' and ')
                .replace(/[^a-z0-9/\s]/g, ' ')
                .replace(/\s+/g, ' ')
                .trim();
        }

        function editDistance(a, b) {
            const rows = a.length + 1;
            const cols = b.length + 1;
            const dp = Array.from({ length: rows }, () => Array(cols).fill(0));

            for (let i = 0; i < rows; i++) dp[i][0] = i;
            for (let j = 0; j < cols; j++) dp[0][j] = j;

            for (let i = 1; i < rows; i++) {
                for (let j = 1; j < cols; j++) {
                    const cost = a[i - 1] === b[j - 1] ? 0 : 1;
                    dp[i][j] = Math.min(
                        dp[i - 1][j] + 1,
                        dp[i][j - 1] + 1,
                        dp[i - 1][j - 1] + cost
                    );
                }
            }

            return dp[a.length][b.length];
        }

        function typoThreshold(length) {
            if (length <= 4) return 0;
            if (length <= 8) return 1;
            if (length <= 14) return 2;
            return 3;
        }

        function isCloseMatch(guess, candidate) {
            if (!guess || !candidate) return false;
            if (guess === candidate) return true;

            if (guess.length >= 4 && (candidate.includes(guess) || guess.includes(candidate))) {
                return true;
            }

            const distance = editDistance(guess, candidate);
            if (distance <= typoThreshold(Math.max(guess.length, candidate.length))) {
                return true;
            }

            const guessTokens = guess.split(' ').filter(Boolean);
            const candidateTokens = candidate.split(' ').filter(Boolean);
            if (guessTokens.length > 1 && candidateTokens.length > 1) {
                const allWordsClose = guessTokens.every((gWord) =>
                    candidateTokens.some((cWord) => {
                        if (gWord === cWord) return true;
                        return editDistance(gWord, cWord) <= typoThreshold(Math.max(gWord.length, cWord.length));
                    })
                );
                if (allWordsClose) return true;
            }

            return false;
        }

        function getGenreCandidates(genre) {
            const variants = new Set();
            const normalizedGenre = normalizeText(genre);
            variants.add(normalizedGenre);

            const slashParts = genre.split('/').map((part) => normalizeText(part)).filter(Boolean);
            slashParts.forEach((part) => variants.add(part));

            return Array.from(variants);
        }

        // --- APP LOGIC ---
        function initApp() {
            startFullRound();
        }

        function startFullRound() {
            roundMode = 'full';
            activeQuizData = [...fullQuizData];
            shuffle(activeQuizData);
            correctCount = 0;
            incorrectCount = 0;
            questionResults = Array.from({ length: activeQuizData.length }, () => null);
            hideEndQuizModal();
            closeResultsModal();
            updateRoundBadge();
            document.getElementById('total-count').innerText = activeQuizData.length;
            loadQuestion(0);
            updateScoreboard();
        }

        function getMissedItems() {
            const missedItems = [];
            questionResults.forEach((result, index) => {
                if (!result || result.isCorrect) return;
                missedItems.push(activeQuizData[index]);
            });
            return missedItems;
        }

        function startMissedRound() {
            hideEndQuizModal();
            closeResultsModal();

            const missedItems = getMissedItems();
            if (missedItems.length === 0) {
                showToast('No missed questions to practice. Great job.');
                return;
            }

            roundMode = 'missed';
            activeQuizData = [...missedItems];
            shuffle(activeQuizData);
            correctCount = 0;
            incorrectCount = 0;
            questionResults = Array.from({ length: activeQuizData.length }, () => null);
            updateRoundBadge();
            document.getElementById('total-count').innerText = activeQuizData.length;
            loadQuestion(0);
            updateScoreboard();
            showToast(`Practice Missed started: ${activeQuizData.length} track${activeQuizData.length === 1 ? '' : 's'}.`);
        }

        function loadQuestion(index) {
            currentIndex = index;
            answered = false;
            lastUserGuess = "";
            
            // UI Reset
            document.getElementById('current-count').innerText = index + 1;
            document.getElementById('user-guess').value = '';
            document.getElementById('user-guess').disabled = false;
            document.getElementById('submit-btn').disabled = false;
            document.getElementById('submit-btn').classList.remove('opacity-60', 'cursor-not-allowed');
            document.getElementById('user-guess').focus();
            document.getElementById('feedback-panel').classList.add('hidden');
            document.getElementById('feedback-panel').classList.remove('flex');
            updateProgress(index);
            
            renderMedia();
            const savedResult = questionResults[index];
            if (savedResult) {
                renderAnswerFeedback(savedResult, activeQuizData[index]);
                document.getElementById('user-guess').value = savedResult.guessRaw;
                document.getElementById('user-guess').disabled = true;
                document.getElementById('submit-btn').disabled = true;
                document.getElementById('submit-btn').classList.add('opacity-60', 'cursor-not-allowed');
                answered = true;
            }
            initIcons();
        }

        function renderMedia() {
            const item = activeQuizData[currentIndex];
            const container = document.getElementById('media-container');
            const linkBtn = document.getElementById('backup-btn');
            
            // Update Link Button
            if (linkBtn) linkBtn.href = item.link;

            let src = item.link;

            // Auto-convert Google Drive 'view' links to 'preview'
            if (src.includes('drive.google.com') && src.includes('/view')) {
                src = src.replace(/\/view.*/, '/preview');
            }

            container.innerHTML = `
                <div class="flex flex-col items-center w-full h-full gap-2 transition-all duration-500 ease-in-out">
                    <iframe id="main-iframe" src="${src}" 
                        class="w-full h-full min-h-[280px] rounded-xl shadow-sm bg-black border border-slate-700" 
                        allow="autoplay; encrypted-media; fullscreen" 
                        allowfullscreen>
                    </iframe>
                </div>
            `;
        }

        function handleKeyPress(e) {
            if(e.key === 'Enter') checkAnswer();
        }

        function checkAnswer() {
            if(answered) return;
            
            const guessInput = document.getElementById('user-guess');
            const userGuessRaw = guessInput.value.trim();
            const userGuess = normalizeText(userGuessRaw);
            const currentItem = activeQuizData[currentIndex];
            const genreCandidates = getGenreCandidates(currentItem.genre);
            
            if (!userGuess) return;
            
            answered = true;
            guessInput.disabled = true;
            document.getElementById('submit-btn').disabled = true;
            document.getElementById('submit-btn').classList.add('opacity-60', 'cursor-not-allowed');

            // Supports slash-based alternatives and minor misspellings.
            const isCorrect = genreCandidates.some((candidate) => isCloseMatch(userGuess, candidate));

            // Update counters
            if (isCorrect) {
                correctCount += 1;
            } else {
                incorrectCount += 1;
            }
            questionResults[currentIndex] = {
                isCorrect,
                guessRaw: userGuessRaw
            };
            updateScoreboard();
            renderAnswerFeedback(questionResults[currentIndex], currentItem, true);
            
            initIcons();
        }

        function renderAnswerFeedback(result, item, shouldCelebrate = false) {
            const banner = document.getElementById('result-banner');
            if (result.isCorrect) {
                banner.className = 'p-4 rounded-xl flex items-center gap-3 border border-emerald-700/50 bg-emerald-900/30';
                banner.innerHTML = `
                    <div class="bg-emerald-600 p-2 rounded-full text-white"><i data-lucide="check" class="w-6 h-6"></i></div>
                    <div class="w-full">
                        <h3 class="text-emerald-300 font-bold text-lg">Correct Answer!</h3>
                        <div class="mt-2 inline-flex flex-wrap items-center gap-2 text-sm">
                            <span class="rounded-md border border-emerald-500/60 bg-emerald-950/40 px-2.5 py-1 text-emerald-100">
                                Genre: <strong>${item.genre}</strong>
                            </span>
                        </div>
                    </div>
                `;
            } else {
                banner.className = 'p-4 rounded-xl flex items-center gap-3 border border-rose-700/50 bg-rose-900/30';
                banner.innerHTML = `
                    <div class="bg-rose-600 p-2 rounded-full text-white"><i data-lucide="x" class="w-6 h-6"></i></div>
                    <div class="w-full">
                        <h3 class="text-rose-300 font-bold text-lg">Not quite right.</h3>
                        <div class="mt-2 flex flex-wrap items-center gap-2 text-sm">
                            <span class="rounded-md border border-rose-500/60 bg-rose-950/50 px-2.5 py-1 text-rose-100">
                                Your guess: <strong>"${result.guessRaw}"</strong>
                            </span>
                            <span class="rounded-md border border-emerald-500/60 bg-emerald-950/40 px-2.5 py-1 text-emerald-100">
                                Correct: <strong>${item.genre}</strong>
                            </span>
                        </div>
                    </div>
                `;
            }

            document.getElementById('info-title').innerText = item.genre;
            document.getElementById('info-composer').innerText = item.title;
            document.getElementById('info-context').innerText = item.composer;
            document.getElementById('info-characteristics').innerText = item.characteristics;

            const panel = document.getElementById('feedback-panel');
            panel.classList.remove('hidden');
            panel.classList.add('flex');

            if (result.isCorrect && shouldCelebrate) {
                confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 }, colors: ['#10b981', '#34d399', '#6ee7b7'] });
            }
        }

        function prevQuestion() {
            if (currentIndex > 0) {
                loadQuestion(currentIndex - 1);
            }
        }

        function nextQuestion() {
            if (currentIndex < activeQuizData.length - 1) {
                loadQuestion(currentIndex + 1);
            } else {
                showEndQuizModal();
            }
        }

        function showEndQuizModal() {
            const modal = document.getElementById('end-quiz-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function hideEndQuizModal() {
            const modal = document.getElementById('end-quiz-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showResultsModal() {
            const modal = document.getElementById('results-modal');
            modal.classList.remove('hidden');
            modal.classList.add('flex');
        }

        function closeResultsModal() {
            const modal = document.getElementById('results-modal');
            modal.classList.add('hidden');
            modal.classList.remove('flex');
        }

        function showResultsSummary() {
            hideEndQuizModal();
            const totalAnswered = correctCount + incorrectCount;
            const unanswered = activeQuizData.length - totalAnswered;
            const accuracy = totalAnswered === 0 ? 0 : Math.round((correctCount / totalAnswered) * 100);
            const correctItems = [];
            const incorrectItems = [];

            questionResults.forEach((result, index) => {
                if (!result) return;
                const item = activeQuizData[index];
                const label = `${index + 1}. ${item.title} (${item.genre})`;
                if (result.isCorrect) {
                    correctItems.push(label);
                } else {
                    incorrectItems.push(`${label} - your guess: "${result.guessRaw}"`);
                }
            });

            document.getElementById('results-summary').innerText =
                `${correctCount} correct, ${incorrectCount} incorrect, ${accuracy}% accuracy. ${unanswered} unanswered.`;

            document.getElementById('correct-list').innerHTML = correctItems.length
                ? correctItems.map((line) => `<li>${line}</li>`).join('')
                : '<li>None yet.</li>';

            document.getElementById('incorrect-list').innerHTML = incorrectItems.length
                ? incorrectItems.map((line) => `<li>${line}</li>`).join('')
                : '<li>None.</li>';

            showResultsModal();
        }

        function restartQuiz() {
            hideEndQuizModal();
            closeResultsModal();
            initApp();
            showToast('Quiz restarted. Scores reset.');
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toast-msg').innerText = msg;
            t.classList.remove('opacity-0', 'translate-y-10');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 3000);
            initIcons();
        }

        // --- INIT ---
        window.onload = () => {
            initApp();
            initIcons();

            document.addEventListener('keydown', (e) => {
                const activeEl = document.activeElement;
                const typingInGuess = activeEl && activeEl.id === 'user-guess';

                if (typingInGuess) return;
                if (e.key === 'ArrowRight') nextQuestion();
                if (e.key === 'ArrowLeft') prevQuestion();
            });
        };

    </script>
</body>
</html>
